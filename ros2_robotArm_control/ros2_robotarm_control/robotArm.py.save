#!/usr/bin/env python

import rclpy
from rclpy.node import Node
from color_srv.srv import Detection
import time
import RPi.GPIO as GPIO

finger = 11 #GPIO17
wrist = 13 #GPIO27
wristV = 15 #GPIO22
elbow = 12 #GPIO18
shoulder = 16 #GPIO23
pShoulder = 18 #GPIO24

color = {'red':1, 'blue':2, 'green':3, 'yellow':4}
colors = {1:'red', 2:'blue', 3:'green', 4:'yellow'}

class ServoControl(Node):
	def __init__(self):
		super().__init__('picking_service')
		self.initServo()
		self.srv = self.create_service(Detection, 'picking', self.motor)
		self.get_logger().info("create service")
	def motor(self, request, response):
		response.result = request.color
		self.get_logger().info('Detect: %s, %d, %d' % (colors[request.color], request.x, request.y))
		self.servoControl(request)
		return response

	def initServo(self):
		GPIO.setmode(GPIO.BOARD)
		GPIO.setup(finger, GPIO.OUT)
		GPIO.setup(wrist, GPIO.OUT)
		GPIO.setup(wristV, GPIO.OUT)
		GPIO.setup(elbow, GPIO.OUT)
		GPIO.setup(shoulder, GPIO.OUT)
		GPIO.setup(pShoulder, GPIO.OUT)
		self.fin = GPIO.PWM(finger, 50)
		self.wri = GPIO.PWM(wrist, 50)
		self.wriV = GPIO.PWM(wristV, 50)
		self.elb = GPIO.PWM(elbow, 50)
		self.shd = GPIO.PWM(shoulder, 50)
		self.pShd = GPIO.PWM(pShoulder, 50)
		self.fin.start(0)
		self.wri.start(0)
		self.wriV.start(0)
		self.elb.start(0)
		self.shd.start(0)
		self.pShd.start(0)

	def servoControl(self, req):
	#floor2=[0,0,10,30,100,180]
		
		self.fin.ChangeDutyCycle(3) #3 open / 7.5 close / 4.5grab
		#time.sleep(1)
		self.wri.ChangeDutyCycle(1) #1-12(clock) 1 normal
		#time.sleep(1)
		self.wriV.ChangeDutyCycle(4) #1-7 4 normal
		time.sleep(1)
		self.elb.ChangeDutyCycle(4) #1-6 / 1 180degree / 6 40degree
		#time.sleep(1)
		self.shd.ChangeDutyCycle(8) #2 10degree / 12 180(front)
		#time.sleep(1)
		self.pShd.ChangeDutyCycle(7) #2 back / 12 front
		time.sleep(3)
		print("servo finish")
		
		self.fin.stop()
		self.wri.stop()
		self.wriV.stop()
		self.elb.stop()
		self.shd.stop()
		self.pShd.stop()
		GPIO.cleanup()

def main(args=None):
	rclpy.init(args=args)
	servo_control = ServoControl()
	rclpy.spin(servo_control)
	rclpy.shutdown()


if __name__ == '__main__':
	main()
